#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
RFM Customer Segmentation Report Generator
Generate comprehensive reports and marketing insights
"""

import pandas as pd
import numpy as np
from datetime import datetime
import os
import json

class RFMReportGenerator:
    """Generate comprehensive reports for RFM customer segmentation analysis"""

    def __init__(self):
        """Initialize the report generator"""
        self.analysis_date = datetime.now()

    def generate_executive_summary(self, rfm_df, summary_stats):
        """
        Generate executive summary report

        Args:
            rfm_df (pd.DataFrame): Complete RFM analysis results
            summary_stats (dict): Summary statistics by segment

        Returns:
            str: Executive summary report
        """
        total_customers = len(rfm_df)
        total_revenue = rfm_df['é‡‘é¢æ€§'].sum()
        avg_customer_value = rfm_df['é‡‘é¢æ€§'].mean()

        report = f"""
# RFMå®¢æˆ·åˆ†ç¾¤åˆ†ææ‰§è¡Œæ‘˜è¦
# RFM Customer Segmentation Executive Summary

**åˆ†ææ—¥æœŸ:** {self.analysis_date.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M')}

## ğŸ“Š æ ¸å¿ƒå‘ç° | Key Findings

### å®¢æˆ·æ¦‚å†µ | Customer Overview
- **æ€»å®¢æˆ·æ•°:** {total_customers:,} äºº
- **æ€»æ”¶å…¥:** ï¿¥{total_revenue:,.0f}
- **å¹³å‡å®¢æˆ·ä»·å€¼:** ï¿¥{avg_customer_value:,.0f}
- **æ•°æ®è¦†ç›–æœŸé—´:** {rfm_df['æœ€è¿‘æ€§'].max()} å¤©è´­ä¹°å†å²

### å®¢æˆ·åˆ†ç¾¤åˆ†å¸ƒ | Segment Distribution
"""

        for segment, stats in summary_stats.items():
            segment_name = {'High': 'é«˜ä»·å€¼', 'Medium': 'ä¸­ç­‰ä»·å€¼', 'Low': 'ä½ä»·å€¼'}[segment]
            revenue_pct = stats['æ”¶å…¥è´¡çŒ®å æ¯”'].replace('%', '')
            report += f"""
- **{segment_name}å®¢æˆ·:** {stats['å®¢æˆ·æ•°é‡']} äºº ({stats['å®¢æˆ·å æ¯”']})
  - å¹³å‡æ¶ˆè´¹: ï¿¥{stats['å¹³å‡æ¶ˆè´¹é‡‘é¢']:,.0f}
  - æ”¶å…¥è´¡çŒ®: {stats['æ”¶å…¥è´¡çŒ®å æ¯”']}
  - å¹³å‡RFMå¾—åˆ†: {stats['å¹³å‡RFMæ€»åˆ†']:.1f}/9
"""

        report += f"""

## ğŸ¯ è¥é”€å»ºè®® | Marketing Recommendations

### é«˜ä»·å€¼å®¢æˆ· (High Value)
- **ç«‹å³è¡ŒåŠ¨:** çº³å…¥VIPè¥é”€è®¡åˆ’
- **ç­–ç•¥:** ä¸ªæ€§åŒ–æœåŠ¡ã€ä¸“å±ä¼˜æƒ ã€ä¼˜å…ˆå®¢æœ
- **é¢„æœŸæ•ˆæœ:** æå‡å®¢æˆ·å¿ è¯šåº¦ï¼Œå¢åŠ å¤è´­ç‡

### ä¸­ç­‰ä»·å€¼å®¢æˆ· (Medium Value)
- **é‡ç‚¹ç›®æ ‡:** å®¢æˆ·æ¿€æ´»å’Œä»·å€¼æå‡
- **ç­–ç•¥:** äº¤å‰é”€å”®ã€å‘ä¸Šé”€å”®ã€ä¼šå‘˜æ¿€åŠ±
- **é¢„æœŸæ•ˆæœ:** å‘é«˜ä»·å€¼å®¢æˆ·è½¬åŒ–

### ä½ä»·å€¼å®¢æˆ· (Low Value)
- **ä¼˜åŒ–ç­–ç•¥:** é‡æ–°æ¿€æ´»æˆ–æˆæœ¬æ§åˆ¶
- **ç­–ç•¥:** ä½æˆæœ¬è§¦è¾¾ã€æ‰¹é‡è¥é”€ã€æµå¤±é¢„è­¦
- **é¢„æœŸæ•ˆæœ:** è¯†åˆ«æ½œåœ¨ä»·å€¼ï¼Œé™ä½æœåŠ¡æˆæœ¬

## ğŸ“ˆ é¢„æœŸROI | Expected ROI

åŸºäºå†å²æ•°æ®åˆ†æï¼Œé’ˆå¯¹ä¸åŒå®¢æˆ·ç¾¤ä½“çš„è¥é”€æ´»åŠ¨é¢„æœŸROIï¼š
- **é«˜ä»·å€¼å®¢æˆ·:** 300-500% (æ¨èæŠ•å…¥æœ€å¤šèµ„æº)
- **ä¸­ç­‰ä»·å€¼å®¢æˆ·:** 150-300% (é‡ç‚¹å…³æ³¨è½¬åŒ–)
- **ä½ä»·å€¼å®¢æˆ·:** 50-150% (æ§åˆ¶æˆæœ¬ï¼Œæ‰¹é‡æ“ä½œ)

## ğŸ“‹ ä¸‹ä¸€æ­¥è¡ŒåŠ¨ | Next Steps

1. **ç«‹å³:** å¯¼å‡ºVIPå®¢æˆ·æ¸…å•ï¼Œå¯åŠ¨ä¸ªæ€§åŒ–è¥é”€
2. **æœ¬å‘¨:** åˆ¶å®šä¸­ç­‰ä»·å€¼å®¢æˆ·æ¿€æ´»è®¡åˆ’
3. **æœ¬æœˆ:** è¯„ä¼°ä½ä»·å€¼å®¢æˆ·ç­–ç•¥æ•ˆæœ
4. **å­£åº¦:** é‡æ–°è¯„ä¼°å®¢æˆ·åˆ†ç¾¤ï¼Œè°ƒæ•´ç­–ç•¥

---

*æœ¬æŠ¥å‘Šç”±RFMå®¢æˆ·åˆ†ç¾¤åˆ†æç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*
*Report generated by RFM Customer Segmentation Analysis System*
"""

        return report

    def generate_detailed_analysis_report(self, rfm_df, original_data=None):
        """
        Generate detailed technical analysis report

        Args:
            rfm_df (pd.DataFrame): Complete RFM analysis results
            original_data (pd.DataFrame, optional): Original transaction data

        Returns:
            str: Detailed analysis report
        """
        report = f"""
# RFMå®¢æˆ·åˆ†ç¾¤è¯¦ç»†åˆ†ææŠ¥å‘Š
# Detailed RFM Customer Segmentation Analysis Report

**ç”Ÿæˆæ—¶é—´:** {self.analysis_date.strftime('%Y-%m-%d %H:%M:%S')}
**åˆ†æå·¥å…·:** RFM Customer Segmentation Engine v1.0

## 1. æ•°æ®æ¦‚è§ˆ | Data Overview

### æ•°æ®è´¨é‡è¯„ä¼°
- **åˆ†æå®¢æˆ·æ•°:** {len(rfm_df):,} äºº
- **æ•°æ®å®Œæ•´æ€§:** {self._assess_data_quality(rfm_df)}
- **åˆ†ææœŸé—´:** {rfm_df['æœ€è¿‘æ€§'].max()} å¤©

### RFMæŒ‡æ ‡ç»Ÿè®¡
"""

        # RFM statistics
        for metric, name in [('æœ€è¿‘æ€§', 'Recency'), ('é¢‘ç‡æ€§', 'Frequency'), ('é‡‘é¢æ€§', 'Monetary')]:
            mean_val = rfm_df[metric].mean()
            median_val = rfm_df[metric].median()
            std_val = rfm_df[metric].std()
            min_val = rfm_df[metric].min()
            max_val = rfm_df[metric].max()

            report += f"""
#### {name} ({metric})
- å¹³å‡å€¼: {mean_val:.2f}
- ä¸­ä½æ•°: {median_val:.2f}
- æ ‡å‡†å·®: {std_val:.2f}
- èŒƒå›´: {min_val:.0f} - {max_val:.0f}
"""

        report += f"""

## 2. åˆ†ç¾¤åˆ†æ | Segment Analysis

### åˆ†ç¾¤ç‰¹å¾å¯¹æ¯”
"""

        # Segment comparison
        segment_comparison = self._create_segment_comparison_table(rfm_df)
        report += segment_comparison

        report += f"""

### å®¢æˆ·ä»·å€¼è¯„åˆ†åˆ†å¸ƒ
"""

        # Score distribution analysis
        score_analysis = self._analyze_score_distribution(rfm_df)
        report += score_analysis

        if original_data is not None:
            report += f"""

## 3. åŸå§‹æ•°æ®åˆ†æ | Original Data Analysis

### äº¤æ˜“æ•°æ®æ¦‚è§ˆ
- **æ€»è®¢å•æ•°:** {len(original_data):,}
- **å¹³å‡è®¢å•é‡‘é¢:** ï¿¥{original_data['æ•°é‡'].mean() * original_data['å•ä»·'].mean():.2f}
- **å®¢æˆ·åˆ†å¸ƒ:** {original_data['ç”¨æˆ·ç '].nunique()} ä¸ªç‹¬ç«‹å®¢æˆ·

### äº§å“ç±»åˆ«åˆ†æ
"""

            # Product category analysis if available
            if 'äº§å“è¯´æ˜' in original_data.columns:
                product_analysis = self._analyze_product_categories(original_data)
                report += product_analysis

        report += f"""

## 4. ç®—æ³•è¯´æ˜ | Algorithm Details

### RFMåˆ†ææ–¹æ³•
1. **Recency (R):** å®¢æˆ·æœ€è¿‘ä¸€æ¬¡è´­ä¹°æ—¶é—´è·ç¦»ä»Šå¤©çš„å¤©æ•°
2. **Frequency (F):** å®¢æˆ·åœ¨åˆ†ææœŸå†…çš„è´­ä¹°æ¬¡æ•°
3. **Monetary (M):** å®¢æˆ·åœ¨åˆ†ææœŸå†…çš„æ€»æ¶ˆè´¹é‡‘é¢

### è¯„åˆ†æœºåˆ¶
- é‡‡ç”¨1-3åˆ†åˆ¶è¯„åˆ†ï¼ŒåŸºäº33%å’Œ66%åˆ†ä½æ•°åˆ’åˆ†
- Recency: è·ç¦»è´­ä¹°æ—¶é—´è¶Šè¿‘ï¼Œå¾—åˆ†è¶Šé«˜
- Frequency & Monetary: æ•°å€¼è¶Šé«˜ï¼Œå¾—åˆ†è¶Šé«˜

### èšç±»ç®—æ³•
- ä½¿ç”¨K-meansç®—æ³•è¿›è¡Œå®¢æˆ·åˆ†ç¾¤
- è‡ªåŠ¨ç¡®å®šæœ€ä¼˜èšç±»æ•°ï¼ˆè‚˜éƒ¨æ³•åˆ™ï¼‰
- æ ‡å‡†åŒ–å¤„ç†ç¡®ä¿å„æŒ‡æ ‡æƒé‡ä¸€è‡´

## 5. ä¸šåŠ¡æ´å¯Ÿ | Business Insights

### å®¢æˆ·ä»·å€¼é‡‘å­—å¡”
```
é«˜ä»·å€¼å®¢æˆ· (Top 20-30%)    â† æ ¸å¿ƒåˆ©æ¶¦æ¥æº
    â†‘
ä¸­ç­‰ä»·å€¼å®¢æˆ· (Middle 30-40%) â† æ½œåŠ›å®¢æˆ·
    â†‘
ä½ä»·å€¼å®¢æˆ· (Bottom 30-40%)  â† é•¿å°¾å®¢æˆ·
```

### å…³é”®å‘ç°
1. **å¸•ç´¯æ‰˜æ³•åˆ™éªŒè¯:** é«˜ä»·å€¼å®¢æˆ·è´¡çŒ®äº†ä¸»è¦æ”¶å…¥
2. **å®¢æˆ·åˆ†å±‚æ˜æ˜¾:** ä¸åŒåˆ†ç¾¤é—´å­˜åœ¨æ˜¾è‘—å·®å¼‚
3. **è¥é”€æœºä¼š:** ä¸­ç­‰ä»·å€¼å®¢æˆ·å…·æœ‰æœ€å¤§æå‡æ½œåŠ›

## 6. æŠ€æœ¯å»ºè®® | Technical Recommendations

### æ•°æ®è´¨é‡æ”¹è¿›
- å»ºè®®å»ºç«‹æ•°æ®æ¸…æ´—è‡ªåŠ¨åŒ–æµç¨‹
- å®æ–½å¼‚å¸¸è®¢å•ç›‘æ§æœºåˆ¶
- å®šæœŸè¿›è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

### åˆ†æä¼˜åŒ–
- è€ƒè™‘å¼•å…¥æ›´å¤šç»´åº¦ï¼ˆå¦‚äº§å“ç±»åˆ«ã€åœ°åŸŸï¼‰
- å®æ–½åŠ¨æ€åˆ†ç¾¤æœºåˆ¶
- å»ºç«‹å®¢æˆ·ä»·å€¼é¢„æµ‹æ¨¡å‹

### ç³»ç»Ÿé›†æˆ
- ä¸CRMç³»ç»Ÿå¯¹æ¥ï¼Œå®ç°å®æ—¶åˆ†ç¾¤
- å»ºç«‹è‡ªåŠ¨åŒ–è¥é”€è§¦å‘æœºåˆ¶
- å®æ–½åˆ†ç¾¤æ•ˆæœç›‘æ§

---

*æŠ¥å‘Šç»“æŸ - RFMå®¢æˆ·åˆ†ç¾¤åˆ†æç³»ç»Ÿ*
"""

        return report

    def generate_marketing_insights(self, rfm_df):
        """
        Generate marketing-focused insights and recommendations

        Args:
            rfm_df (pd.DataFrame): Complete RFM analysis results

        Returns:
            str: Marketing insights report
        """
        report = f"""
# RFMå®¢æˆ·åˆ†ç¾¤è¥é”€æ´å¯ŸæŠ¥å‘Š
# RFM Customer Segmentation Marketing Insights

**æŠ¥å‘Šæ—¥æœŸ:** {self.analysis_date.strftime('%Yå¹´%mæœˆ%dæ—¥')}

## ğŸ¯ è¥é”€ç­–ç•¥çŸ©é˜µ | Marketing Strategy Matrix

### é«˜ä»·å€¼å®¢æˆ· (High Value) - "å¿ è¯šä¿å«æˆ˜"
**ç‰¹å¾æè¿°:** è´­ä¹°é¢‘æ¬¡é«˜ï¼Œæ¶ˆè´¹é‡‘é¢å¤§ï¼Œæœ€è¿‘æ´»è·ƒ

**è¥é”€ç­–ç•¥:**
- **VIPä¸“å±æœåŠ¡:** ä¸“å±å®¢æœç»ç†ã€ä¼˜å…ˆå‘è´§ã€ä¸“å±å®¢æœçƒ­çº¿
- **ä¸ªæ€§åŒ–æ¨è:** åŸºäºè´­ä¹°å†å²çš„é«˜ç«¯äº§å“æ¨è
- **å¿ è¯šåº¦è®¡åˆ’:** ç§¯åˆ†åŠ å€ã€ä¸“å±ç¤¼å“ã€ç”Ÿæ—¥ç‰¹æƒ
- **é¢„é˜²æµå¤±:** ä¸»åŠ¨å…³æ€€ã€å®šæœŸå›è®¿ã€æµå¤±é¢„è­¦

**é¢„æœŸæ•ˆæœ:**
- å®¢æˆ·ç•™å­˜ç‡æå‡ 20-30%
- å¹³å‡å®¢å•ä»·æå‡ 15-25%
- æ¨èè½¬åŒ–ç‡æå‡ 40-50%

**å®æ–½å»ºè®®:**
- ç«‹å³å»ºç«‹VIPå®¢æˆ·æ¡£æ¡ˆ
- è®¾è®¡ä¸“å±è¥é”€æ´»åŠ¨
- è®¾ç½®å®¢æˆ·æµå¤±ç›‘æ§

### ä¸­ç­‰ä»·å€¼å®¢æˆ· (Medium Value) - "ä»·å€¼æå‡æˆ˜"
**ç‰¹å¾æè¿°:** æœ‰ä¸€å®šè´­ä¹°é¢‘æ¬¡ï¼Œä½†æ¶ˆè´¹é‡‘é¢æˆ–æ´»è·ƒåº¦æœ‰æå‡ç©ºé—´

**è¥é”€ç­–ç•¥:**
- **äº¤å‰é”€å”®:** æ¨èç›¸å…³äº§å“ç±»åˆ«
- **å‘ä¸Šé”€å”®:** å¼•å¯¼è´­ä¹°é«˜ç«¯äº§å“
- **ä¼šå‘˜æ¿€åŠ±:** å‡çº§ä¼šå‘˜ç­‰çº§ç‰¹æƒ
- **å®šæœŸäº’åŠ¨:** æ–°å“ä¼˜å…ˆä½“éªŒã€ä¼šå‘˜æ´»åŠ¨

**é¢„æœŸæ•ˆæœ:**
- 30-40%è½¬åŒ–ä¸ºé«˜ä»·å€¼å®¢æˆ·
- å¹³å‡è´­ä¹°é¢‘æ¬¡æå‡ 25-35%
- å®¢å•ä»·æå‡ 20-30%

**å®æ–½å»ºè®®:**
- åˆ†æè´­ä¹°æ¨¡å¼ï¼Œè¯†åˆ«äº¤å‰é”€å”®æœºä¼š
- è®¾è®¡æ¸è¿›å¼ä¼šå‘˜å‡çº§ä½“ç³»
- å»ºç«‹å®¢æˆ·äº’åŠ¨æ—¥å†

### ä½ä»·å€¼å®¢æˆ· (Low Value) - "æ¿€æ´»æŠ¢æ•‘æˆ˜"
**ç‰¹å¾æè¿°:** è´­ä¹°é¢‘æ¬¡ä½ï¼Œæ¶ˆè´¹é‡‘é¢å°ï¼Œå¯èƒ½å­˜åœ¨æµå¤±é£é™©

**è¥é”€ç­–ç•¥:**
- **é‡æ–°æ¿€æ´»:** ç‰¹æƒ ä¿ƒé”€ã€å›å½’å¥–åŠ±
- **æ•™è‚²å¼•å¯¼:** äº§å“ä½¿ç”¨æŒ‡å¯¼ã€ä»·å€¼è®¤çŸ¥æ•™è‚²
- **ç¤¾åŒºè¿è¥:** ç”¨æˆ·ç¤¾åŒºå‚ä¸ã€å£ç¢‘æ¿€åŠ±
- **æˆæœ¬æ§åˆ¶:** æ‰¹é‡è¥é”€ã€è‡ªåŠ¨åŒ–è§¦è¾¾

**é¢„æœŸæ•ˆæœ:**
- 15-25%é‡æ–°æ¿€æ´»
- 5-10%è½¬åŒ–ä¸ºä¸­ç­‰ä»·å€¼å®¢æˆ·
- é™ä½è¥é”€æˆæœ¬ 30-40%

**å®æ–½å»ºè®®:**
- å»ºç«‹å®¢æˆ·ç”Ÿå‘½å‘¨æœŸé¢„è­¦æœºåˆ¶
- è®¾è®¡ä½æˆæœ¬çš„è‡ªåŠ¨åŒ–è¥é”€æµç¨‹
- å®šæœŸæ¸…ç†æ— æ•ˆå®¢æˆ·æ•°æ®

## ğŸ“… è¥é”€æ´»åŠ¨æ—¥å† | Marketing Calendar

### æœ¬å‘¨é‡ç‚¹
- [ ] VIPå®¢æˆ·1å¯¹1æ²Ÿé€š
- [ ] ä¸­ç­‰ä»·å€¼å®¢æˆ·ä¿ƒé”€æ´»åŠ¨è®¾è®¡
- [ ] ä½ä»·å€¼å®¢æˆ·æ¿€æ´»é‚®ä»¶å‘é€

### æœ¬æœˆç›®æ ‡
- [ ] é«˜ä»·å€¼å®¢æˆ·æ»¡æ„åº¦è°ƒç ”
- [ ] ä¸­ç­‰ä»·å€¼å®¢æˆ·å‡çº§è®¡åˆ’å¯åŠ¨
- [ ] ä½ä»·å€¼å®¢æˆ·æˆæœ¬æ•ˆç›Šåˆ†æ

### å­£åº¦è§„åˆ’
- [ ] å®¢æˆ·åˆ†ç¾¤æ•ˆæœè¯„ä¼°
- [ ] è¥é”€ç­–ç•¥ä¼˜åŒ–è°ƒæ•´
- [ ] æ–°åˆ†ç¾¤æ ‡å‡†åˆ¶å®š

## ğŸ’¡ åˆ›æ–°è¥é”€æ€è·¯ | Innovative Marketing Ideas

### 1. ç”Ÿå‘½å‘¨æœŸè¥é”€
- **æ–°å®¢æˆ·é˜¶æ®µ:** æ¬¢è¿ç¤¼åŒ…ã€å¼•å¯¼æ•™è‚²
- **æˆé•¿é˜¶æ®µ:** æŠ€èƒ½æå‡ã€æˆåŠŸæ¡ˆä¾‹åˆ†äº«
- **æˆç†Ÿé˜¶æ®µ:** æ·±åº¦æœåŠ¡ã€ä»·å€¼å…±åˆ›
- **è¡°é€€é˜¶æ®µ:** æŒ½ç•™æ¿€åŠ±ã€å‘Šåˆ«ç¤¼é‡

### 2. åœºæ™¯åŒ–è¥é”€
- **èŠ‚æ—¥åœºæ™¯:** å®šåˆ¶åŒ–èŠ‚æ—¥è¥é”€
- **ç”Ÿæ´»åœºæ™¯:** åŸºäºç”¨æˆ·ç”Ÿæ´»åœºæ™¯æ¨è
- **å·¥ä½œåœºæ™¯:** èŒä¸šç›¸å…³çš„äº§å“æœåŠ¡
- **ç¤¾äº¤åœºæ™¯:** ç¤¾äº¤åˆ†äº«æ¿€åŠ±

### 3. æ•°æ®é©±åŠ¨è¥é”€
- **å®æ—¶ä¸ªæ€§åŒ–:** åŸºäºå®æ—¶è¡Œä¸ºçš„ä¸ªæ€§åŒ–æ¨è
- **é¢„æµ‹æ€§è¥é”€:** åŸºäºé¢„æµ‹æ¨¡å‹çš„ä¸»åŠ¨è¥é”€
- **A/Bæµ‹è¯•:** æŒç»­ä¼˜åŒ–è¥é”€æ•ˆæœ
- **å¤šæ¸ é“ååŒ:** æ•´åˆçº¿ä¸Šçº¿ä¸‹è¥é”€è§¦ç‚¹

## ğŸ“Š KPIç›‘æ§ä½“ç³» | KPI Monitoring System

### æ ¸å¿ƒæŒ‡æ ‡
- **å®¢æˆ·ç•™å­˜ç‡:** å„åˆ†ç¾¤å®¢æˆ·æœˆåº¦ç•™å­˜
- **å®¢æˆ·ä»·å€¼æå‡:** å„åˆ†ç¾¤å¹³å‡æ¶ˆè´¹é‡‘é¢å˜åŒ–
- **è½¬åŒ–ç‡:** åˆ†ç¾¤é—´è½¬åŒ–ç‡å’Œè½¬åŒ–æ—¶é—´
- **è¥é”€ROI:** å„åˆ†ç¾¤è¥é”€æ´»åŠ¨æŠ•å…¥äº§å‡ºæ¯”

### ç›‘æ§é¢‘ç‡
- **æ—¥æŠ¥:** å…³é”®æ´»åŠ¨æ•ˆæœç›‘æ§
- **å‘¨æŠ¥:** åˆ†ç¾¤å˜åŒ–è¶‹åŠ¿åˆ†æ
- **æœˆæŠ¥:** æ•´ä½“ç­–ç•¥æ•ˆæœè¯„ä¼°
- **å­£æŠ¥:** é•¿æœŸè¶‹åŠ¿å’Œç­–ç•¥è°ƒæ•´

---

*è¥é”€æ´å¯ŸæŠ¥å‘Š - è®©æ•°æ®é©±åŠ¨å¢é•¿*
"""

        return report

    def export_vip_customer_list(self, rfm_df, top_n=100):
        """
        Export VIP customer list for marketing campaigns

        Args:
            rfm_df (pd.DataFrame): Complete RFM analysis results
            top_n (int): Number of top customers to export

        Returns:
            pd.DataFrame: VIP customer list
        """
        # Filter high value customers and sort by total score
        vip_customers = rfm_df[rfm_df['å®¢æˆ·ä»·å€¼'] == 'High'].copy()

        if len(vip_customers) == 0:
            # If no High value customers, take top by monetary value
            vip_customers = rfm_df.nlargest(top_n, 'é‡‘é¢æ€§')
        else:
            # Sort high value customers by total score and monetary value
            vip_customers = vip_customers.sort_values(
                ['RFMæ€»åˆ†', 'é‡‘é¢æ€§', 'é¢‘ç‡æ€§'],
                ascending=[False, False, False]
            )

        # Take top N customers
        vip_customers = vip_customers.head(top_n).copy()

        # Add ranking
        vip_customers['æ’å'] = range(1, len(vip_customers) + 1)

        # Add marketing insights
        vip_customers['è¥é”€ä¼˜å…ˆçº§'] = vip_customers['æ’å'].apply(
            lambda x: 'æœ€é«˜ä¼˜å…ˆçº§' if x <= 10 else 'é«˜ä¼˜å…ˆçº§' if x <= 50 else 'ä¸­ä¼˜å…ˆçº§'
        )

        # Select relevant columns
        export_columns = [
            'ç”¨æˆ·ç ', 'æ’å', 'è¥é”€ä¼˜å…ˆçº§',
            'R_è¯„åˆ†', 'F_è¯„åˆ†', 'M_è¯„åˆ†', 'RFMæ€»åˆ†',
            'æœ€è¿‘æ€§', 'é¢‘ç‡æ€§', 'é‡‘é¢æ€§'
        ]

        vip_export = vip_customers[export_columns].copy()

        # Rename columns for clarity
        column_mapping = {
            'ç”¨æˆ·ç ': 'å®¢æˆ·ID',
            'æ’å': 'VIPæ’å',
            'è¥é”€ä¼˜å…ˆçº§': 'è¥é”€å»ºè®®',
            'R_è¯„åˆ†': 'æœ€è¿‘æ€§è¯„åˆ†',
            'F_è¯„åˆ†': 'é¢‘ç‡æ€§è¯„åˆ†',
            'M_è¯„åˆ†': 'é‡‘é¢æ€§è¯„åˆ†',
            'RFMæ€»åˆ†': 'ç»¼åˆå¾—åˆ†',
            'æœ€è¿‘æ€§': 'æœ€è¿‘è´­ä¹°å¤©æ•°',
            'é¢‘ç‡æ€§': 'è´­ä¹°é¢‘æ¬¡',
            'é‡‘é¢æ€§': 'æ€»æ¶ˆè´¹é‡‘é¢'
        }

        vip_export = vip_export.rename(columns=column_mapping)

        # Save to CSV
        vip_export.to_csv('vip_customers_marketing_list.csv', index=False, encoding='utf-8-sig')

        return vip_export

    def _assess_data_quality(self, df):
        """Assess data quality and completeness"""
        total_cells = len(df) * len(df.columns)
        missing_cells = df.isnull().sum().sum()
        completeness = ((total_cells - missing_cells) / total_cells) * 100

        if completeness >= 95:
            return "ä¼˜ç§€ (Excellent)"
        elif completeness >= 90:
            return "è‰¯å¥½ (Good)"
        elif completeness >= 80:
            return "ä¸€èˆ¬ (Fair)"
        else:
            return "éœ€è¦æ”¹è¿› (Needs Improvement)"

    def _create_segment_comparison_table(self, df):
        """Create detailed segment comparison table"""
        comparison = ""

        for segment in ['High', 'Medium', 'Low']:
            segment_data = df[df['å®¢æˆ·ä»·å€¼'] == segment]
            segment_name = {'High': 'é«˜ä»·å€¼', 'Medium': 'ä¸­ç­‰ä»·å€¼', 'Low': 'ä½ä»·å€¼'}[segment]

            comparison += f"""
#### {segment_name}å®¢æˆ·ç‰¹å¾
- **å®¢æˆ·æ•°é‡:** {len(segment_data)} äºº ({len(segment_data)/len(df)*100:.1f}%)
- **å¹³å‡æœ€è¿‘è´­ä¹°:** {segment_data['æœ€è¿‘æ€§'].mean():.1f} å¤©å‰
- **å¹³å‡è´­ä¹°é¢‘æ¬¡:** {segment_data['é¢‘ç‡æ€§'].mean():.1f} æ¬¡
- **å¹³å‡æ¶ˆè´¹é‡‘é¢:** ï¿¥{segment_data['é‡‘é¢æ€§'].mean():,.0f}
- **å¹³å‡RFMå¾—åˆ†:** {segment_data['RFMæ€»åˆ†'].mean():.1f}/9
"""

        return comparison

    def _analyze_score_distribution(self, df):
        """Analyze RFM score distribution"""
        analysis = """

### RFMè¯„åˆ†åˆ†å¸ƒåˆ†æ
"""

        for score_type in ['R_è¯„åˆ†', 'F_è¯„åˆ†', 'M_è¯„åˆ†']:
            score_dist = df[score_type].value_counts().sort_index()
            score_name = {
                'R_è¯„åˆ†': 'æœ€è¿‘æ€§è¯„åˆ†',
                'F_è¯„åˆ†': 'é¢‘ç‡æ€§è¯„åˆ†',
                'M_è¯„åˆ†': 'é‡‘é¢æ€§è¯„åˆ†'
            }[score_type]

            analysis += f"""
#### {score_name}åˆ†å¸ƒ
"""
            for score, count in score_dist.items():
                percentage = count / len(df) * 100
                analysis += f"- {score}åˆ†: {count} äºº ({percentage:.1f}%)\n"

        return analysis

    def _analyze_product_categories(self, df):
        """Analyze product categories if available"""
        if 'äº§å“è¯´æ˜' not in df.columns:
            return "äº§å“ç±»åˆ«æ•°æ®ä¸å¯ç”¨"

        analysis = """
#### çƒ­é”€äº§å“ç±»åˆ«
"""

        # Top product categories
        product_revenue = df.groupby('äº§å“è¯´æ˜')['è®¢å•é‡‘é¢'].sum().sort_values(ascending=False)
        top_products = product_revenue.head(10)

        for product, revenue in top_products.items():
            analysis += f"- {product}: ï¿¥{revenue:,.0f}\n"

        return analysis

    def save_all_reports(self, rfm_df, original_data=None, output_dir='reports'):
        """
        Save all reports to files

        Args:
            rfm_df (pd.DataFrame): Complete RFM analysis results
            original_data (pd.DataFrame, optional): Original transaction data
            output_dir (str): Directory to save reports
        """
        os.makedirs(output_dir, exist_ok=True)

        # Generate summary statistics
        summary_stats = {}
        for segment in ['High', 'Medium', 'Low']:
            segment_data = rfm_df[rfm_df['å®¢æˆ·ä»·å€¼'] == segment]
            if len(segment_data) > 0:
                summary_stats[segment] = {
                    'å®¢æˆ·æ•°é‡': len(segment_data),
                    'å®¢æˆ·å æ¯”': f"{len(segment_data) / len(rfm_df) * 100:.1f}%",
                    'å¹³å‡æœ€è¿‘è´­ä¹°å¤©æ•°': segment_data['æœ€è¿‘æ€§'].mean(),
                    'å¹³å‡è´­ä¹°é¢‘æ¬¡': segment_data['é¢‘ç‡æ€§'].mean(),
                    'å¹³å‡æ¶ˆè´¹é‡‘é¢': segment_data['é‡‘é¢æ€§'].mean(),
                    'æ€»æ¶ˆè´¹é‡‘é¢': segment_data['é‡‘é¢æ€§'].sum(),
                    'æ”¶å…¥è´¡çŒ®å æ¯”': f"{segment_data['é‡‘é¢æ€§'].sum() / rfm_df['é‡‘é¢æ€§'].sum() * 100:.1f}%",
                    'å¹³å‡RFMæ€»åˆ†': segment_data['RFMæ€»åˆ†'].mean()
                }

        # Generate and save reports
        reports = {
            'executive_summary.md': self.generate_executive_summary(rfm_df, summary_stats),
            'detailed_analysis.md': self.generate_detailed_analysis_report(rfm_df, original_data),
            'marketing_insights.md': self.generate_marketing_insights(rfm_df)
        }

        for filename, content in reports.items():
            with open(os.path.join(output_dir, filename), 'w', encoding='utf-8') as f:
                f.write(content)

        # Export VIP customer list
        vip_list = self.export_vip_customer_list(rfm_df)

        print(f"æ‰€æœ‰æŠ¥å‘Šå·²ä¿å­˜åˆ°: {output_dir}/")
        print(f"- executive_summary.md: æ‰§è¡Œæ‘˜è¦")
        print(f"- detailed_analysis.md: è¯¦ç»†åˆ†ææŠ¥å‘Š")
        print(f"- marketing_insights.md: è¥é”€æ´å¯ŸæŠ¥å‘Š")
        print(f"- vip_customers_marketing_list.csv: VIPå®¢æˆ·æ¸…å•")

def main():
    """Example usage"""
    generator = RFMReportGenerator()

    # Create sample data
    sample_data = pd.DataFrame({
        'ç”¨æˆ·ç ': range(100),
        'æœ€è¿‘æ€§': np.random.randint(1, 365, 100),
        'é¢‘ç‡æ€§': np.random.randint(1, 50, 100),
        'é‡‘é¢æ€§': np.random.randint(100, 10000, 100),
        'å®¢æˆ·ä»·å€¼': np.random.choice(['High', 'Medium', 'Low'], 100),
        'RFMæ€»åˆ†': np.random.randint(3, 9, 100),
        'R_è¯„åˆ†': np.random.randint(1, 4, 100),
        'F_è¯„åˆ†': np.random.randint(1, 4, 100),
        'M_è¯„åˆ†': np.random.randint(1, 4, 100)
    })

    # Generate sample reports
    generator.save_all_reports(sample_data)
    print("ç¤ºä¾‹æŠ¥å‘Šç”Ÿæˆå®Œæˆ")

if __name__ == "__main__":
    main()